#!/usr/bin/env bash
# .sh/bin/setup-deb 20170519 - 20180222
# Copyright (C) 1995-2017 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ $1 == '-h' || $1 == '--help' ]] && \
    echo "Usage: setup-deb [mysql(default)|sqlite]" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo)" && exit 2

source ~/.defaults || exit 3

EXDEB="apt-get -yqq"
export DEBIAN_FRONTEND=noninteractive
export TERM=linux

# Default list of packages
DLIST="
  bc
  bsd-mailx
  busybox-static
  ca-certificates
  curl
  deborphan
  dnsutils
  gawk
  git
  iptables
  mtr-tiny
  mutt
  nano
  net-tools
  openssh-server
  pwgen
  rsync
  sqlite3
  ssmtp
  sudo
  time
  unzip
  wget
  whois
"

# Default remove list (RLIST="" to ignore removal)
RLIST="
  *golang*
  *python*
  accountsservice
  apache2
  at
  bind9
  cloud*
  lxcfs
  man*
  open-iscsi
  rpcbind
  sasl2-bin
  ttf-*
  vi*
  xinetd
"

# Basic SQLite packages
SLIST="
  apache2-utils
  dovecot-imapd
  dovecot-lmtpd
  dovecot-managesieved
  dovecot-sqlite
  fcgiwrap
  mailgraph
  mutt
  nginx-light
  opendkim
  opendkim-tools
  pdns-backend-sqlite3
  pflogsumm
  php$V_PHP
  php$V_PHP-curl
  php$V_PHP-fpm
  php$V_PHP-gd
  php$V_PHP-imap
  php$V_PHP-intl
  php$V_PHP-mbstring
  php$V_PHP-sqlite3
  php$V_PHP-xml
  postfix-policyd-spf-perl
  postfix-sqlite
  spamprobe
"

# Additional and optional MySQL packages
MLIST="
  dovecot-mysql
  mariadb-client
  mariadb-server
  pdns-backend-mysql
  php7.1-mysql
  postfix-mysql
"

# OpenVZ has some wierd sysctl settings
[[ -f /proc/vz/veinfo ]] && mv /etc/sysctl.d /etc/sysctl.d.orig

if [[ ! -f /etc/apt/apt.conf.d/20local ]]; then
    echo "<<< Create /etc/apt/apt.conf.d/20local"
    cat << EOS | tee /etc/apt/apt.conf.d/20local > /dev/null
APT::Install-Recommends "false";
Dpkg::Options {
    "--force-confdef";
    "--force-confold";
}
EOS
    cp /usr/share/zoneinfo/$TAREA/$TCITY /etc/localtime
    dpkg-reconfigure -f noninteractive tzdata > /dev/null 2>&1
fi

echo "<<< Updating current packages, patience please..."
$EXDEB update > /dev/null 2>&1
$EXDEB -u dist-upgrade > /dev/null 2>&1

if [[ ! -f /etc/apt/sources.list.orig ]]; then
    echo "<<< Setup apt sources list for $OSREL"
    mv /etc/apt/sources.list /etc/apt/sources.list.orig
    cat << EOS | tee /etc/apt/sources.list > /dev/null
# apt-key adv --recv-keys --keyserver keyserver.ubuntu.com KEY
# apt-get install --no-install-recommends packages

deb http://$OSMIR/ubuntu $OSREL main universe
deb http://$OSMIR/ubuntu $OSREL-updates main universe
deb http://$OSMIR/ubuntu $OSREL-backports main universe
deb http://security.ubuntu.com/ubuntu $OSREL-security main universe
EOS
    [[ $(($(stat -c %X /var/cache/apt/pkgcache.bin)+3600)) < $(date +%s) ]] && \
        echo "<<< Updating new package list for $OSREL, patience please..." && \
        $EXDEB update && \
        $EXDEB -u dist-upgrade > /dev/null 2>&1
fi

# Unique trigger to know if $DLIST packages are already installed
if [[ ! -e /usr/bin/bsd-mailx ]]; then
    echo "<<< Installing default package set, more patience..."
    $EXDEB install $DLIST > /dev/null 2>&1
fi

if [[ -e /usr/bin/python && -n $RLIST ]]; then
    echo "<<< Remove python and all related packages"
    $EXDEB --purge remove $RLIST > /dev/null 2>&1
fi

if [[ ! -e /usr/sbin/nginx ]]; then
    echo "<<< Installing default applicaton set, yet more patience..."
    cat << EOS | debconf-set-selections
postfix postfix/destinations string 'localhost'
postfix postfix/mailname string '$VHOST'
postfix postfix/main_mailer_type string 'Internet Site'
EOS
    $EXDEB install $SLIST > /dev/null 2>&1
fi

if [[ $1 == mysql ]] && [[ ! -e /usr/sbin/mysqld ]]; then
    $EXDEB install $MLIST > /dev/null 2>&1

    # Change to utf8 otherwise pdns tables will not install
    sed -i \
        -e "/^character-set-server/ s/utf8mb4/utf8/" \
        -e "/^collation-server/ s/utf8mb4_general_ci/utf8_general_ci/" \
        $C_SQL/mariadb.conf.d/50-server.cnf

    # Give up on preseeding, just make the changes directly
    cat << EOS | mysql
UPDATE mysql.user SET plugin='';
UPDATE mysql.user SET Password=PASSWORD('$DPASS') WHERE User='root';
DELETE FROM mysql.user WHERE User='';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
FLUSH PRIVILEGES;
EOS
    echo "<<< Create MariaDB root user (cat ~/.my.cnf for password)"
    systemctl restart mysql
fi

echo "<<< Disable pdns until actually needed"
systemctl stop pdns > /dev/null 2>&1
systemctl disable pdns > /dev/null 2>&1

echo "<<< Installed Debian packages"

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
