#!/usr/bin/env bash
# .sh/bin/setup-host 20170524 - 20180311
# Copyright (C) 1995-2018 Mark Constable <markc@renta.net> (AGPL-3.0)

# Essential host package list, adjust accordingly
HLIST="
bc
bind9-host
bsd-mailx
ca-certificates
curl
git
iptables
mutt
nano
openssh-server
rsync
ssmtp
"

[[ $1 =~ '-h' ]] && \
    echo "Usage: setup-host [domain] [mysql(default)|sqlite] [admin(sysadm)]" && exit 1

[[ $(id -u) -gt 0 ]] && echo "!!! ERROR: must be root (use sudo -i)" && exit 2

AHOST=${1:-$(hostname -f)} # Admin Host must be hostname.domainname
DTYPE=${2:-'mysql'}
UUSER=${3:-'sysadm'}

# Make sure that IP4 is the default
grep -q '^#precedence ::ffff:0:0/96  100' /etc/gai.conf
if [[ $? -eq 0 ]]; then
    echo "!!! Warning: giving preference to IPv4 over IPv6 (Ubuntu default)"
    sed -i 's;#precedence ::ffff:0:0/96  100;precedence ::ffff:0:0/96  100;' /etc/gai.conf
fi

echo "!!! Updating CURRENT package list, patience please..."
apt-get -yqq update > /dev/null 2>&1
DEBIAN_FRONTEND=noninteractive apt-get -yqq --no-install-recommends -u dist-upgrade > /dev/null 2>&1
echo "!!! Installing default package set, more patience..."
DEBIAN_FRONTEND=noninteractive apt-get -yqq --no-install-recommends install $HLIST > /dev/null 2>&1

# After essential host package update so we definitely have git
if [[ ! -d /root/.sh ]]; then
    echo "!!! Setup NetServa SH scripts"
    cd
    git clone -q https://github.com/netserva/sh .sh > /dev/null
    /root/.sh/bin/shm install > /dev/null
    /root/.sh/bin/shm perms
fi

# Setup default admin vhost if not exists
if [[ ! -f /root/.vhosts/$AHOST ]]; then
    echo "!!! Create initial vhost config /root/.vhosts/$AHOST"
    [[ ! -d /root/.vhosts ]] && mkdir /root/.vhosts && chmod 700 /root/.vhosts
    source /root/.sh/lib/functions
    sethost $UUSER@$AHOST $(newpw 5)
    gethost > /root/.vhosts/$AHOST && chmod 600 /root/.vhosts/$AHOST
    source /root/.vhosts/$AHOST
fi

[[ ! -d $VPATH ]] && echo "!!! Create $VPATH" && mkdir $VPATH

if [[ ! -f /etc/ssh/sshd_config.orig ]]; then
    echo "!!! Create new /etc/ssh/sshd_config"
    mv /etc/ssh/sshd_config /etc/ssh/sshd_config.orig
    cp /root/.sh/etc/_etc_ssh_sshd__config /etc/ssh/sshd_config
    systemctl restart ssh
fi

if [[ ! -d /root/.ssh ]]; then
    echo "!!! Create host /root/.ssh dir"
    mkdir /root/.ssh
    chmod 700 /root/.ssh
fi

if [[ ! -f /root/.ssh/id_rsa ]]; then
    echo "!!! Create host /root/.ssh/id_rsa key"
    ssh-keygen -t rsa -f /root/.ssh/id_rsa -N '' > /dev/null
    cat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys
    chmod 600 /root/.ssh/*
fi

if [[ ! -f /root/.ssh/config ]]; then
    echo "!!! Create host /root/.ssh/config"
    cat << EOS | tee -a /root/.ssh/config > /dev/null
# Host example.org
#   Hostname example.org (or 12.34.56.78)

Host *
  TCPKeepAlive yes
  ServerAliveInterval 30
  IdentityFile /root/.ssh/id_rsa
  Port 9
  User root
EOS
    chmod 600 /root/.ssh/*
fi

if [[ -f /etc/NetworkManager/NetworkManager.conf ]]; then
    if [[ ! -f /etc/NetworkManager/dispatcher.d/99iptables ]]; then
        echo "!!! Create desktop iptables save/restore"
        cp /root/.sh/etc/_etc_NetworkManager_dispatcher.d_99iptables \
            /etc/NetworkManager/dispatcher.d/99iptables
        chmod +x /etc/NetworkManager/dispatcher.d/99iptables
    fi
else
    if [[ ! -f /etc/network/if-post-down.d/iptsave ]]; then
        echo "!!! (not) Create server iptables save/restore (needs to be updated for systemd-networkd)"
#        cp /root/.sh/etc/_etc_network_if-post-down.d_iptsave \
#            /etc/network/if-post-down.d/iptsave
#        chmod +x /etc/network/if-post-down.d/iptsave

#        cp /root/.sh/etc/_etc_network_if-pre-up.d_iptrestore \
#            /etc/network/if-pre-up.d/iptrestore
#        chmod +x /etc/network/if-pre-up.d/iptrestore
    fi
fi

[[ ! -f /etc/iptables.rules ]] && ssheriff clear && ssheriff

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
