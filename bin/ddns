#!/usr/bin/env bash
# .sh/bin/ddns 20180606 - 20180607
# Copyright (C) 1995-2018 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ -z $1 || $1 =~ "-h" ]] && echo "Usage: ddns [domain] [apikey] [dns script]" && exit 1

# Either pass the 3 values above or hardwire them below

DDNS_FOR=${1:-''}
DDNS_KEY=${2:-''}
DDNS_URL=${3:-''}

OLDIP=

[[ -f /var/tmp/ip ]] && OLDIP=$(< /var/tmp/ip)

NEWIP=$(curl -s https://canihazip.com/s)

echo $NEWIP | grep -qE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b"

if [[ $? -gt 0 ]]; then
    echo "$NEWIP is not a valid IP"
elif [[ -z $OLDIP || $NEWIP != $OLDIP ]]; then
    echo $NEWIP > /var/tmp/ip
    curl -s "$DDNS_URL?key=$DDNS_KEY&for=$DDNS_FOR"
fi

#systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
