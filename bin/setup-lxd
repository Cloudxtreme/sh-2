#!/usr/bin/env bash
# .sh/bin/setup-lxd 20170519 - 20170529
# Copyright (C) 1995-2017 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ -z $1 ]] && echo "Usage: setup-lxd FQDN [small|medium|large] [pool size (25)] [passwd] [IP]" && exit 1

source ~/.defaults || exit 2

_PLAN=${2:-'small'}
PSIZE=${3:-'25'}
APASS=${4:-$APASS}
IP4_0=${4:-$IP4_0}

if [[ ! -d /var/lib/lxd ]]; then
    echo "--- Install packages for lxd lxd-client zfsutils-linux"

    [[ $(($(stat -c %X /var/cache/apt/pkgcache.bin)+3600)) < $(date +%s) ]] \
        && $SUDO apt-get -qq update > /dev/null 2>&1

    DEBIAN_FRONTEND=noninteractive $SUDO apt install -yqq --no-install-recommends \
        lxd lxd-client zfsutils-linux > /dev/null 2>&1

    echo "--- Install lxd with $PSIZE GB zfs pool"
    # switch group to lxd
    sg lxd -c "lxd init --auto \
      --network-address $IP4_0 \
      --network-port 8443 \
      --storage-backend zfs \
      --storage-create-loop $PSIZE \
      --storage-pool lxd-pool \
      --trust-password $APASS"
fi

sg lxd -c "newlxd $1 $_PLAN"

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
