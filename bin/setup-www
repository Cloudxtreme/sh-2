#!/usr/bin/env bash
# .sh/bin/setup-www 20170519 - 20170529
# Copyright (C) 1995-2017 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ -z $2 ]] && echo "Usage: setup-www user@domain|domain mysql|sqlite [user_pw] [mysql_pw] [shell_pw]" && exit 1

source ~/.sh/lib/defaults || exit 2

[[ ! -d $VPATH ]] && mkdir -p $VPATH

addvhost $*

cd $UPATH/var

[[ -d www ]] && mv www www_old

echo "!!! Clone Netserva HCP to $WPATH"
git clone https://github.com/netserva/www > /dev/null 2>&1

[[ -d www_old/public ]] && mv www_old/public www
[[ -d www_old/private ]] && mv www_old/private www

if [[ -f ~/.ssh/authorized_keys ]]; then
    echo "!!! Create .ssh/authorized_keys"
    cp ~/.ssh/authorized_keys $UPATH/.ssh
fi

chperms $VHOST > /dev/null

echo "!!! Setup Netserva HCP -> https://$VHOST"
echo "!!! Note: if this container has outside net access with DNS pointing to it's"
echo "!!! FQDN then use \"newssl $VHOST\" to provide a LetsEncrypt SSL certificate."

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
