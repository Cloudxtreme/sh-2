#!/usr/bin/env bash
# .sh/bin/setup-www 20170519 - 20170716
# Copyright (C) 1995-2017 Mark Constable <markc@renta.net> (AGPL-3.0)
set -x
[[ -z $2 ]] && echo "Usage: setup-www domain mysql|sqlite" && exit 1

source ~/.sh/lib/defaults || exit 2

[[ ! -d $VPATH ]] && mkdir -p $VPATH

# First, setup the adm subdomain with NetServa HCP

addvhost $ADMIN@adm.$VHOST $2 $(< /root/.pw)

cd $UPATH/var

[[ -d www && ! -d www_old ]] && mv www www_old

if [[ -d $WPATH/.git ]]; then
    echo "*** $WPATH/.git (HCP) already exists"
else
    echo "*** Clone Netserva HCP to $WPATH"
    git clone https://github.com/netserva/www > /dev/null 2>&1
fi

if [[ -d $WPATH/phpmyadmin ]]; then
    echo "*** $WPATH/phpmyadmin already exists"
else
    echo "*** Setup phpmyadmin to $WPATH/phpmyadmin"
    wget -q https://www.phpmyadmin.net/downloads/phpMyAdmin-latest-english.tar.gz
    tar xf phpMyAdmin-latest-english.tar.gz > /dev/null 2>&1
    mv phpMyAdmin-*/ www/phpmyadmin
    mv www/phpmyadmin/config.sample.inc.php www/phpmyadmin/config.inc.php
    ENCPW=$(newpw 4 | tr ' ' _)
    sed -i "/blowfish_secret/ s/''/'$ENCPW'/" www/phpmyadmin/config.inc.php
    rm phpMyAdmin-latest-english.tar.gz
fi

if [[ -d $WPATH/webmail ]]; then
    echo "*** $WPATH/webmail already exists"
else
    echo "*** Setup phpmyadmin to $WPATH/webmail"
    mkdir www/webmail
    cd www/webmail
    wget -q https://www.rainloop.net/repository/webmail/rainloop-latest.zip
    unzip rainloop-latest.zip > /dev/null 2>&1
    rm rainloop-latest.zip
fi

if [[ -f $UPATH/.ssh/authorized_keys ]]; then
    echo "*** $UPATH/.ssh/authorized_keys already exists"
else
    if [[ -f ~/.ssh/id_rsa.pub ]]; then
        echo "*** Create $UPATH/.ssh/authorized_keys"
        cp ~/.ssh/id_rsa.pub $UPATH/.ssh/authorized_keys
    fi
fi

if [[ -f $WPATH/.htpasswd ]]; then
    echo "*** $WPATH/.htpasswd already exists"
else
    PIN=$RANDOM
    echo "*** Create $WPATH/.htpasswd sysadm/$PIN"
    htpasswd -b -c $WPATH/.htpasswd sysadm $PIN
fi

echo $DPASS > $WPATH/lib/.ht_pw
chperms adm.$VHOST > /dev/null 2>&1

# Now set up the main VHOST

addvhost $VHOST $2 $(< /root/.pw)
newautoconfig $VHOST
[[ -d www_old/public ]] && mv www_old/public www
[[ -d www_old/private ]] && mv www_old/private www
chperms $VHOST > /dev/null 2>&1

# Default route IP
R_IP4=$(ip -4 route get 8.8.8.8 | awk '/src/ {print $7}')

# DNS vhost IP
D_IP4=$(host -t a $VHOST|cut -d' ' -f4)

if [[ $R_IP4 == $D_IP4 ]]; then
    sleep 1
    newssl $VHOST adm cdn www > /dev/null 2>&1
    echo "*** Setup Netserva HCP -> https://adm.$VHOST"
else
    echo "*** Setup Netserva HCP -> http://adm.$VHOST"
    echo "*** Note: if this server has outside net access"
    echo "***  with DNS pointing to it's FQDN then use"
    echo "*** \"newssl $VHOST adm cdn www\""
    echo "*** to provide a LetsEncrypt SSL certificate."
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
