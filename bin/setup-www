#!/usr/bin/env bash
# .sh/bin/setup-www 20170519 - 20170529
# Copyright (C) 1995-2017 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ -z $2 ]] && echo "Usage: setup-www user@domain|domain mysql|sqlite [user_pw] [mysql_pw] [shell_pw]" && exit 1

source ~/.sh/lib/defaults || exit 2

[[ ! -d $VPATH ]] && mkdir -p $VPATH

addvhost $*

cd $UPATH/var

[[ -d www ]] && mv www www_old

echo "!!! Clone Netserva HCP to $WPATH"
git clone https://github.com/netserva/www > /dev/null 2>&1

[[ -d www_old/public ]] && mv www_old/public www
[[ -d www_old/private ]] && mv www_old/private www

if [[ -f ~/.ssh/authorized_keys ]]; then
    echo "!!! Create .ssh/authorized_keys"
    cp ~/.ssh/authorized_keys $UPATH/.ssh
fi

if [[ ! -f /usr/share/nginx/html/50x.html ]]; then
    echo "!!! Create /usr/share/nginx/html/50x.html"
    cat << EOS | $SUDO tee /usr/share/nginx/html/50x.html > /dev/null
<!DOCTYPE html>
<html>
<head>
<title>Error</title>
<style>
body { width: 35em; margin: 0 auto; font-family: sans-serif; }
</style>
</head>
<body>
<h1>An error occurred.</h1>
<p>Sorry, the page you are looking for is currently unavailable.<br/>
Please try again later.</p>
<p>If you are the system administrator of this resource then you should check
the <a href="http://nginx.org/r/error_log">error log</a> for details.</p>
<p><em>Faithfully yours, nginx.</em></p>
</body>
</html>
EOS
fi

newautoconfig $VHOST

echo $DPASS > $WPATH/lib/.ht_pw

chperms $VHOST > /dev/null 2>&1

# Default route IP
R_IP4=$(ip -4 route get 8.8.8.8 | awk '/src/ {print $7}')

# DNS vhost IP
D_IP4=$(host -t a $VHOST|cut -d' ' -f4)

if [[ $R_IP4 == $D_IP4 ]]; then
    sleep 2
    newssl $VHOST > /dev/null 2>&1
    echo "!!! Setup Netserva HCP -> https://$VHOST"
else
    echo "!!! Setup Netserva HCP -> http://$VHOST"
    echo "!!! Note: if this container has outside net access with DNS pointing to it's"
    echo "!!! FQDN then use \"newssl $VHOST\" to provide a LetsEncrypt SSL certificate."
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
