#!/usr/bin/env bash
# .sh/bin/logging 20170417 - 20180419
# Copyright (C) 1995-2018 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ -z $1 || $1 =~ '-h' ]] && echo "Usage: logging domain|all [update]" && exit 1

[[ $(id -u) -gt 0 ]] && echo "!!! ERROR: must be root (use sudo -i)" && exit 2

source ~/.shrc || exit 3

[[ $2 == update ]] && UPD=1 || UPD=

DU="/usr/bin/du -sb"
FIND="/usr/bin/find"
YMD=$(date +%Y-%m-%d)

log_vhost()
{
    local UPATH=$VPATH/$1
    local MPATH=$UPATH/home
    local WPATH=$UPATH/var/www
    local UDU=0; local MDU=0; local WDU=0;

    [[ -d $UPATH ]] && UDU=$($DU $UPATH | cut -f1)
    [[ -d $MPATH ]] && MDU=$($DU $MPATH | cut -f1)
    [[ -d $WPATH ]] && WDU=$($DU $WPATH | cut -f1)

    if [[ $UPD ]]; then
        echo "INSERT INTO vhost_log (hid, ymd, size_mpath, size_wpath, size_upath) VALUES ($2, '$YMD', $MDU, $WDU, $UDU)" | $SQCMD
    else
        printf "%-48s %9s %9s %9s\n" $1 $(numfmt --to=si $MDU) $(numfmt --to=si $WDU) $(numfmt --to=si $UDU)
    fi
}

log_vmail()
{
    local MPATH=$VPATH/$1/home
    [[ ! -d $MPATH ]] && echo "Warning: $MPATH does not exist"
    local MBOXS=$(find $MPATH -mindepth 1 -maxdepth 1 -type d \! -type l \! -name "u" | sort)

    for MBOX in $MBOXS; do
        local HDU=0; local MDU=0; local SDU=0; local INUM=0; local SNUM=0; local TNUM=0;

        [[ -d $MBOX ]] && HDU=$($DU $MBOX | cut -f1)
        [[ -d $MBOX/Maildir ]] && MDU=$($DU $MBOX/Maildir | cut -f1)
        [[ -d $MBOX/.spamprobe ]] && SDU=$($DU $MBOX/.spamprobe | cut -f1)

        [[ -d $MBOX/Maildir ]] && TNUM=$($FIND $MBOX/Maildir -name "[0-9][0-9]*" | wc -l)
        [[ -d $MBOX/Maildir/cur ]] && INUM=$($FIND $MBOX/Maildir/cur -name "[0-9][0-9]*" | wc -l)
        [[ -d $MBOX/Maildir/.Spam/cur ]] && SNUM=$($FIND $MBOX/Maildir/.Spam/cur -name "[0-9][0-9]*" | wc -l)

        if [[ $UPD ]]; then
            local VUSER="$(basename $MBOX)@$1"
            MID=$(echo "SELECT id FROM vmails WHERE user='$VUSER'" | $SQCMD)
            echo "INSERT INTO vmail_log (mid, ymd, size_mail, size_spam, size_home, num_inbox, num_spam, num_total) VALUES ($MID, '$YMD', $MDU, $SDU, $HDU, $INUM, $SNUM, $TNUM)" | $SQCMD
        else
            printf "  %-46s %9s %9s %9s\n" "$(basename $MBOX)@$1" $(numfmt --to=si $MDU) $(numfmt --to=si $SDU) $(numfmt --to=si $HDU)
        fi
    done
}

log_all()
{
    HID=$(echo "SELECT id FROM vhosts WHERE domain='$1'" | $SQCMD)
    if [[ $HID -gt 0 ]]; then
        log_vhost $1 $HID
        log_vmail $1 $HID
    else
        echo "Warning: '$1' did not return a HID from '$SQCMD'"
    fi
}

[[ $UPD ]] || printf "%-48s %9s %9s %9s\n" "Vhost / Mailbox" "Mail/Box" "Web/Spam" "Disk/Home"

if [[ $1 == all ]]; then
    VHOSTS=$(find $VPATH -mindepth 1 -maxdepth 1 -type d \! -type l | sed "s#$VPATH/##" | sort)
    for VHOST in $VHOSTS; do log_all $VHOST; done
else
    log_all $1
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
