#!/usr/bin/env bash
# .sh/bin/delvhost 20170216 - 20180223
# Copyright (C) 1995-2018 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ $1 =~ -h ]] && echo "Usage: delvhost [domain]" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

source ~/.vhosts/${1:-$VHOST} || exit 3

[[ ! -d $VPATH/$VHOST ]] && echo "!!! ERROR: '$VPATH/$VHOST' does not exist" && exit 4

DID=$(cat << EOS | $SQCMD
 SELECT id FROM vhosts
  WHERE domain = '$VHOST'
EOS
)

echo "DELETE FROM vhosts WHERE id = $DID" | $SQCMD
echo "DELETE FROM valias WHERE did = $DID" | $SQCMD
echo "DELETE FROM vmails WHERE did = $DID" | $SQCMD
echo "DELETE FROM logging WHERE did = $DID" | $SQCMD

if [[ -f $C_WEB/sites-enabled/$VHOST ]]; then
    echo "!!! Remove $C_WEB/sites-enabled/$VHOST"
    cp $C_WEB/sites-enabled/$VHOST $UPATH/etc
    rm $C_WEB/sites-enabled/$VHOST
fi

if [[ -f $C_FPM/pool.d/$VHOST.conf ]]; then
    echo "!!! Remove $C_FPM/pool.d/$VHOST.conf"
    cp $C_FPM/pool.d/$VHOST.conf $UPATH/etc
    rm $C_FPM/pool.d/$VHOST.conf
fi

# TODO: dump sql database and system entries to $UPATH/etc
# TODO: maybe add BPATH (and BFILE) to defaults config?

[[ ! -d $BPATH ]] && mkdir -p $BPATH
BFILE="$BPATH/$(date +'%Y-%m-%d')-$VHOST.tgz"
[[ -f $BFILE ]] && rm $BFILE

echo "!!! Create $BFILE"
tar czf $BFILE $UPATH > /dev/null 2>&1

VUSER=$(getent passwd | awk -F: "/:$VHOST:/ {print \$1}")

if [[ -z $VUSER ]]; then
    echo "!!! Warning: $VUSER does not exist"
else
    echo "!!! Remove $VUSER"
    userdel -rf $VUSER > /dev/null 2>&1
fi

if [[ -d $UPATH ]]; then
    echo "!!! Remove $UPATH"
    rm -rf $UPATH
fi

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
