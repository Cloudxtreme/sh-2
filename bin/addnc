#!/usr/bin/env bash
# .sh/bin/addnc 20180829 - 20180829
# Copyright (C) 1995-2018 Mark Constable <markc@renta.net> (AGPL-3.0)
set -x
[[ -z $1 || $1 =~ -h ]] && echo "Usage: addnc domain [path]" && exit 1

[[ $(id -u) -gt 0 ]] && echo "ERROR: must be root (use sudo -i)" && exit 2

if [[ -f ~/.vhosts/$1 ]]; then
    source ~/.vhosts/$1
else
    echo "!!! ERROR: set up vhost config first, ie;"
    echo "    sethost $1 [mysql] [IP]"
    echo "    gethost > ~/.vhosts/$1"
    echo "    chmod 600 ~/.vhosts/$1"
    exit 3
fi

[[ ! -d $VPATH ]] && echo "!!! ERROR: $VPATH does NOT exist, run 'setup-host' first" && exit 4
[[ ! -d $WPATH ]] && echo "!!! ERROR: $WPATH does NOT exist, run 'addvhost' first" && exit 5

FPATH=${2:-''}

if [[ $FPATH ]]; then
    WPURL=$SCHEME$VHOST/$FPATH
    FPATH=$WPATH/$FPATH
else
    WPURL=$SCHEME$VHOST
    FPATH=$WPATH
fi

# Exception: keep wp-* tables out of $ADMIN (sysadm) database
if [[ $DNAME == $ADMIN ]]; then
    DNAME=${VHOST//[.-]/_}
fi

if [[ $(mysql -BNe "SHOW DATABASES LIKE '$DNAME'") ]]; then
    echo "!!! '$DNAME' database already exists"
else
    echo "!!! Create $DNAME database"
    mysql -e "CREATE DATABASE IF NOT EXISTS $DNAME"
    mysql -e "GRANT ALL PRIVILEGES ON $DNAME.* TO '$DUSER'@'localhost' IDENTIFIED BY '$DPASS'";
    mysql -e "FLUSH PRIVILEGES"
fi

if [ -f "$FPATH/occ" ]; then
    echo "!!! Nextcloud already installed"
else
    echo "!!! Download Nextcloud"
    cd $UPATH/var
    if [[ ! -f latest.tar.gz ]]; then
        wget -nv --no-check-certificate https://download.nextcloud.com/server/releases/latest.tar.bz2
    fi
    tar xf latest.tar.gz
    rm latest.tar.gz
    if [[ -d $FPATH ]]; then
        [[ -d ${FPATH}_old ]] && rm -rf ${FPATH}_old
        mv $FPATH ${FPATH}_old
    fi
    mv nextcloud $FPATH
    chown $U_UID:www-data -R $FPATH
fi

if [[ -f $FPATH/occ ]]; then
    echo "!!! Setting up Nextcloud"
    su - $UUSER -c "
cd $FPATH
php occ maintenance:install \
  --database $DTYPE \
  --database-name $DNAME \
  --database-user $DUSER \
  --database-pass $DPASS \
  --admin-user sysadm \
  --admin-pass $APASS
"
fi

chperms $vhost

cat << eos | tee -a /root/.vhosts/$vhost.conf
Nextcloud
=========

Nextcloud: $WPURL/admin/
Username: sysadm
Password: $APASS

EOS

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
