#!/usr/bin/env bash
# .sh/bin/setup-tunnel 20181102 - 20181102
# Copyright (C) 1995-2018 Mark Constable <markc@renta.net> (AGPL-3.0)

[[ -z $1 || $1 =~ '-h' ]] && \
    echo "Usage: setup-tunnel forward|reverse|list [targethost] [lport] [rport] [luser] [ruser] [sport] [sshkeyname]" && exit 1

if [[ $1 == list ]]; then
    stat -t /etc/systemd/system/tunnel* >/dev/null 2>&1
#echo $?
    if [[ $? -eq 0 ]]; then
        echo "Tunnel files exit"
    else
        echo "No tunnel systemd services files exit"
    fi
    exit
elif [[ $1 == forward ]]; then
    T_ARG='-L'
    T_STR=Forward
elif [[ $1 == reverse ]]; then
    T_ARG='-R'
    T_STR=Reverse
else
    echo "Tunnel direction must be forward or reverse"
    exit
fi

THOST=${2:-$VHOST}
LPORT=${3:-'9999'}
RPORT=${4:-'9999'}
LUSER=${5:-'tunnel'}
RUSER=${6:-'tunnel'}
SPORT=${7:-'9'}
S_KEY=${8:-'id_rsa'}
SOPTS="-NTC -o ServerAliveInterval=60 -o ExitOnForwardFailure=yes -o StrictHostKeyChecking=no"

if [[ ! -d ~/.ssh ]]; then
    echo ">>> Create local ~/.ssh dir"
    mkdir ~/.ssh
    chmod 700 ~/.ssh
fi

service_file() {
#mbox2 ~ cat /etc/systemd/system/tunnel-9090.service
   cat << EOS
[Unit]
Description=$T_STR SSH Tunnel
ConditionPathExists=|/usr/bin
After=network.target

[Service]
User=$LUSER
ExecStart=/usr/bin/ssh SOPTS -i /home/$LUSER/.ssh/$S_KEY $T_ARG $LPORT:localhost:$RPORT -p$SPORT $RUSER@$THOST
RestartSec=3
Restart=always

[Install]
WantedBy=multi-user.target
EOS
}

service_file $*

systemd-cat -t hlog echo "$(whoami) $(basename $0) $*"
